name: iOS Unsigned Build

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode.app/Contents/Developer

      - name: Resolve project and scheme
        id: resolve
        shell: bash
        run: |
          set -euo pipefail

          WORKSPACE_PATH="$(find . -maxdepth 4 -name "*.xcworkspace" | head -n 1)"
          PROJECT_PATH="$(find . -maxdepth 4 -name "*.xcodeproj" | head -n 1)"

          if [[ -n "${WORKSPACE_PATH}" ]]; then
            CONTAINER_FLAG="-workspace"
            CONTAINER_PATH="${WORKSPACE_PATH}"
            CONTAINER_NAME="$(basename "${WORKSPACE_PATH}" .xcworkspace)"
          elif [[ -n "${PROJECT_PATH}" ]]; then
            CONTAINER_FLAG="-project"
            CONTAINER_PATH="${PROJECT_PATH}"
            CONTAINER_NAME="$(basename "${PROJECT_PATH}" .xcodeproj)"
          else
            echo "No .xcworkspace or .xcodeproj found in repository."
            echo "Commit your Xcode workspace/project files (typically <App>.xcworkspace and/or <App>.xcodeproj)."
            echo "Repository root contents:"
            ls -la
            exit 1
          fi

          SCHEME_NAME="$(xcodebuild ${CONTAINER_FLAG} "${CONTAINER_PATH}" -list | awk '/Schemes:/ {getline; gsub(/^[ \t]+/, ""); print; exit}')"
          if [[ -z "${SCHEME_NAME}" ]]; then
            SCHEME_NAME="${CONTAINER_NAME}"
          fi

          BUILD_DIR="${RUNNER_TEMP}/build"
          echo "container_flag=${CONTAINER_FLAG}" >> "$GITHUB_OUTPUT"
          echo "container_path=${CONTAINER_PATH}" >> "$GITHUB_OUTPUT"
          echo "scheme=${SCHEME_NAME}" >> "$GITHUB_OUTPUT"
          echo "build_dir=${BUILD_DIR}" >> "$GITHUB_OUTPUT"

      - name: Unsigned build
        shell: bash
        run: |
          set -euo pipefail
          xcodebuild \
            "${{ steps.resolve.outputs.container_flag }}" "${{ steps.resolve.outputs.container_path }}" \
            -scheme "${{ steps.resolve.outputs.scheme }}" \
            -configuration Release \
            -sdk iphonesimulator \
            -destination "generic/platform=iOS Simulator" \
            -derivedDataPath "${{ steps.resolve.outputs.build_dir }}" \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            build

      - name: Package .app artifact
        id: package
        shell: bash
        run: |
          set -euo pipefail
          APP_PATH="$(find "${{ steps.resolve.outputs.build_dir }}" -type d -name "*.app" | head -n 1)"
          if [[ -z "${APP_PATH}" ]]; then
            echo "No .app produced by build."
            exit 1
          fi

          ARTIFACT_DIR="${RUNNER_TEMP}/artifacts"
          mkdir -p "${ARTIFACT_DIR}"
          cp -R "${APP_PATH}" "${ARTIFACT_DIR}/"
          ditto -c -k --sequesterRsrc --keepParent "${APP_PATH}" "${ARTIFACT_DIR}/SERLyric.app.zip"

          echo "artifact_dir=${ARTIFACT_DIR}" >> "$GITHUB_OUTPUT"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ios-unsigned-build
          path: ${{ steps.package.outputs.artifact_dir }}

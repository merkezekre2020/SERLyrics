name: iOS IPA Release

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode.app/Contents/Developer

      - name: Resolve project and scheme
        id: resolve
        shell: bash
        run: |
          set -euo pipefail

          WORKSPACE_PATH="$(find . -maxdepth 4 -name "*.xcworkspace" | head -n 1)"
          PROJECT_PATH="$(find . -maxdepth 4 -name "*.xcodeproj" | head -n 1)"

          if [[ -n "${WORKSPACE_PATH}" ]]; then
            CONTAINER_FLAG="-workspace"
            CONTAINER_PATH="${WORKSPACE_PATH}"
            CONTAINER_NAME="$(basename "${WORKSPACE_PATH}" .xcworkspace)"
          elif [[ -n "${PROJECT_PATH}" ]]; then
            CONTAINER_FLAG="-project"
            CONTAINER_PATH="${PROJECT_PATH}"
            CONTAINER_NAME="$(basename "${PROJECT_PATH}" .xcodeproj)"
          else
            echo "No .xcworkspace or .xcodeproj found in repository."
            echo "Commit your Xcode workspace/project files (typically <App>.xcworkspace and/or <App>.xcodeproj)."
            echo "Repository root contents:"
            ls -la
            exit 1
          fi

          SCHEME_NAME="$(xcodebuild ${CONTAINER_FLAG} "${CONTAINER_PATH}" -list | awk '/Schemes:/ {getline; gsub(/^[ \t]+/, ""); print; exit}')"
          if [[ -z "${SCHEME_NAME}" ]]; then
            SCHEME_NAME="${CONTAINER_NAME}"
          fi

          ARCHIVE_PATH="${RUNNER_TEMP}/SERLyric.xcarchive"
          IPA_DIR="${RUNNER_TEMP}/ipa"
          echo "container_flag=${CONTAINER_FLAG}" >> "$GITHUB_OUTPUT"
          echo "container_path=${CONTAINER_PATH}" >> "$GITHUB_OUTPUT"
          echo "scheme=${SCHEME_NAME}" >> "$GITHUB_OUTPUT"
          echo "archive_path=${ARCHIVE_PATH}" >> "$GITHUB_OUTPUT"
          echo "ipa_dir=${IPA_DIR}" >> "$GITHUB_OUTPUT"

      - name: Build archive (unsigned)
        shell: bash
        run: |
          set -euo pipefail
          xcodebuild \
            "${{ steps.resolve.outputs.container_flag }}" "${{ steps.resolve.outputs.container_path }}" \
            -scheme "${{ steps.resolve.outputs.scheme }}" \
            -configuration Release \
            -destination "generic/platform=iOS" \
            -archivePath "${{ steps.resolve.outputs.archive_path }}" \
            SKIP_INSTALL=NO \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY="" \
            archive

      - name: Package unsigned IPA
        id: package
        shell: bash
        run: |
          set -euo pipefail
          APP_PATH="$(find "${{ steps.resolve.outputs.archive_path }}/Products/Applications" -maxdepth 1 -type d -name "*.app" | head -n 1)"
          if [[ -z "${APP_PATH}" ]]; then
            echo "No .app found in archive."
            exit 1
          fi

          IPA_DIR="${{ steps.resolve.outputs.ipa_dir }}"
          rm -rf "${IPA_DIR}"
          mkdir -p "${IPA_DIR}/Payload"
          cp -R "${APP_PATH}" "${IPA_DIR}/Payload/"
          (cd "${IPA_DIR}" && ditto -c -k --sequesterRsrc --keepParent Payload SERLyric-unsigned.ipa)

          echo "ipa_path=${IPA_DIR}/SERLyric-unsigned.ipa" >> "$GITHUB_OUTPUT"

      - name: Prepare release metadata
        id: release_meta
        shell: bash
        run: |
          set -euo pipefail
          TAG="ci-${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}"
          NAME="CI IPA ${GITHUB_RUN_NUMBER} (${GITHUB_SHA:0:7})"
          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"
          echo "name=${NAME}" >> "$GITHUB_OUTPUT"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ios-unsigned-ipa
          path: ${{ steps.package.outputs.ipa_path }}

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.release_meta.outputs.tag }}
          name: ${{ steps.release_meta.outputs.name }}
          generate_release_notes: true
          prerelease: true
          files: |
            ${{ steps.package.outputs.ipa_path }}
